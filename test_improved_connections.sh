#!/bin/bash

echo "ðŸ”§ Testing Improved P2P Connection Stability"
echo "============================================="

# Build the project
echo "ðŸ“¦ Building project with improved connection handling..."
cargo build --features bluetooth --release

if [ $? -ne 0 ]; then
    echo "âŒ Build failed!"
    exit 1
fi

echo "âœ… Build successful!"
echo ""

echo "ðŸš€ Key Improvements Made:"
echo "  â€¢ More frequent keep-alive messages (every 15 seconds)"
echo "  â€¢ Welcome messages sent on connection establishment"
echo "  â€¢ Better connection timeout handling"
echo "  â€¢ Improved message parsing for different message types"
echo "  â€¢ Enhanced logging for connection events"
echo ""

echo "ðŸ“‹ Testing Instructions:"
echo ""
echo "1. Start Device 1 (Bootstrap Node):"
echo "   cargo run --features bluetooth -- --db-path ./device1-data start-with-api --node-port 8082 --api-port 8085"
echo ""
echo "2. Start Device 2 (Connecting Node):"
echo "   cargo run --features bluetooth -- --db-path ./device2-data start-with-api --node-port 8083 --api-port 8086 --bootstrap \"/ip4/[DEVICE1_IP]/tcp/8082\""
echo ""
echo "3. Test Data Gossiping:"
echo "   # On Device 1:"
echo "   curl -X POST http://localhost:8085/api/keys -H \"Content-Type: application/json\" -d '{\"key\": \"test:connection\", \"value\": \"stable\"}'"
echo ""
echo "   # On Device 2:"
echo "   curl http://localhost:8086/api/keys/test:connection"
echo ""
echo "4. Monitor Connection Stability:"
echo "   â€¢ Look for 'âœ… ðŸ“¡ TCP/Wi-Fi Connected to peer' messages"
echo "   â€¢ Look for 'ðŸ‘‹ Received welcome from peer' messages"
echo "   â€¢ Look for 'ðŸ’“ Received keep-alive from peer' messages"
echo "   â€¢ Connections should stay stable without KeepAliveTimeout errors"
echo ""
echo "ðŸ”µ Bluetooth Testing:"
echo "   â€¢ Turn off Wi-Fi on both devices"
echo "   â€¢ Keep Bluetooth enabled"
echo "   â€¢ Look for 'ðŸ”µ Bluetooth Connected to peer' messages"
echo "   â€¢ Data gossiping should continue over Bluetooth"
echo ""
echo "ðŸ“Š Expected Behavior:"
echo "  â€¢ Connections should establish and remain stable"
echo "  â€¢ Keep-alive messages should prevent timeouts"
echo "  â€¢ Welcome messages should confirm peer connections"
echo "  â€¢ Data should gossip reliably between peers"
echo "  â€¢ Bluetooth fallback should work when Wi-Fi is disabled"
echo ""
echo "ðŸŽ¯ Success Criteria:"
echo "  â€¢ No more 'KeepAliveTimeout' disconnections"
echo "  â€¢ Stable peer connections lasting > 5 minutes"
echo "  â€¢ Successful data synchronization between devices"
echo "  â€¢ Bluetooth connectivity when Wi-Fi is unavailable"
echo ""
echo "Ready to test! ðŸš€"
